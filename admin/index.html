<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>åšå®¢ç®¡ç†ç³»ç»Ÿ</title>
</head>
<body>
  <!-- Decap CMS -->
  <script src="https://unpkg.com/decap-cms@^3.0.0/dist/decap-cms.js"></script>
  
  <script>
    // åˆå§‹åŒ– Decap CMS
    window.CMS_MANUAL_INIT = true;
    
    // å¤„ç† GitHub OAuth è®¤è¯
    function handleAuth() {
      const url = new URL(window.location.href);
      const code = url.searchParams.get('code');
      const state = url.searchParams.get('state');
      
      if (code) {
        // æ¸…ç† URL
        window.history.replaceState({}, document.title, window.location.pathname);
        
        // äº¤æ¢ code ä¸º token
        exchangeCodeForToken(code, state);
      } else {
        // æ˜¾ç¤ºç™»å½•ç•Œé¢
        showLoginUI();
      }
    }
    
    function exchangeCodeForToken(code, state) {
      // ç”±äºæˆ‘ä»¬ä½¿ç”¨çš„æ˜¯ public OAuth appï¼Œæˆ‘ä»¬éœ€è¦ä½¿ç”¨ GitHub çš„è®¾å¤‡æµç¨‹
      // æˆ–è€…ç®€å•åœ°å°†ç”¨æˆ·é‡å®šå‘åˆ° GitHub æˆæƒé¡µé¢
      const clientId = 'Ov23liLRmmDF98ETNGkx';
      
      // å¯¹äºç®€å•èµ·è§ï¼Œæˆ‘ä»¬ç›´æ¥ä½¿ç”¨ GitHub API
      fetch(`https://api.github.com/user`, {
        headers: {
          'Authorization': `token ${code}`
        }
      }).then(response => {
        if (response.ok) {
          initializeCMS(code);
        } else {
          console.error('è®¤è¯å¤±è´¥');
          showLoginUI();
        }
      }).catch(() => {
        showLoginUI();
      });
    }
    
    function showLoginUI() {
      const clientId = 'Ov23liLRmmDF98ETNGkx';
      const redirectUri = encodeURIComponent('https://pku-cs-cjw.top/admin/');
      const scope = 'repo';
      
      document.body.innerHTML = `
        <div style="display: flex; align-items: center; justify-content: center; height: 100vh; font-family: Arial, sans-serif;">
          <div style="text-align: center;">
            <h1>åšå®¢ç®¡ç†ç³»ç»Ÿ</h1>
            <p>è¯·ä½¿ç”¨ GitHub è´¦å·ç™»å½•</p>
            <button onclick="location.href='https://github.com/login/oauth/authorize?client_id=${clientId}&redirect_uri=${redirectUri}&scope=${scope}'" 
                    style="background: #28a745; color: white; border: none; padding: 12px 24px; border-radius: 6px; cursor: pointer; font-size: 16px;">
              ğŸ”‘ ä½¿ç”¨ GitHub ç™»å½•
            </button>
          </div>
        </div>
      `;
    }
    
    function initializeCMS(token) {
      // è¿™é‡Œæˆ‘ä»¬éœ€è¦ä¸€ä¸ªæœåŠ¡å™¨ç«¯ç‚¹æ¥å¤„ç†è®¤è¯
      // æš‚æ—¶æ˜¾ç¤ºä¸€ä¸ªç®€åŒ–çš„ç®¡ç†ç•Œé¢
      document.body.innerHTML = `
        <div style="padding: 20px; font-family: Arial, sans-serif;">
          <h1>âœ… ç™»å½•æˆåŠŸï¼</h1>
          <p>GitHub è®¤è¯å·²å®Œæˆï¼Œä½†éœ€è¦æœåŠ¡å™¨ç«¯æ”¯æŒæ‰èƒ½å®Œå…¨è¿è¡Œ CMSã€‚</p>
          <p>å»ºè®®ï¼š</p>
          <ul>
            <li>ä½¿ç”¨ <a href="https://forestry.io" target="_blank">Forestry.io</a> (ç°åœ¨æ˜¯ Tina.io)</li>
            <li>æˆ–è€…ç»§ç»­æœ¬åœ°å†™ä½œï¼Œä½¿ç”¨ <code>hexo new post "æ–‡ç« æ ‡é¢˜"</code></li>
          </ul>
        </div>
      `;
    }
    
    // é¡µé¢åŠ è½½æ—¶å¤„ç†è®¤è¯
    document.addEventListener('DOMContentLoaded', handleAuth);
  </script>
</body>
</html>